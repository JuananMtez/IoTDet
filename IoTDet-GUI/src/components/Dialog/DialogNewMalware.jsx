import React, {useState} from "react";
import Slide from "@mui/material/Slide";
import {Dialog, DialogActions, DialogContent, DialogTitle, Grid, Stack} from "@mui/material";
import IconButton from "@mui/material/IconButton";
import CloseIcon from "@mui/icons-material/Close";
import TextFieldStyled from "../TextFieldStyled/TextFieldStyled.jsx";
import Button from "@mui/material/Button";
import AttachFileIcon from "@mui/icons-material/AttachFile";
import LoadingButton from "@mui/lab/LoadingButton";
import {uploadMalware} from "../../services/FileRequests.js";

const Transition = React.forwardRef(function Transition(props, ref) {
    return <Slide direction="up" ref={ref} {...props} />;
});

const DialogNewMalware = ({open, handleClose, handleSuccess}) => {
    const [stateDialog, setStateDialog] = useState({
        name: '',
        columns: '',
        description: '',
        file_executable: null,
        file_cleaner: null,
        loading: false,
        showError: false,
        textError: ''
    })

    const onChangeFieldsArea = (e) => {

        if (e.target.name === 'name' || e.target.name === 'description')
            setStateDialog({
                ...stateDialog, [e.target.name]: e.target.value
            })
        else if (!e.target.value.includes(' ')) setStateDialog({
            ...stateDialog, [e.target.name]: e.target.value
        })
    }

    const onChangeUploadFile = (event, type) => {
        if (type === 'executable')
            setStateDialog({
                ...stateDialog, file_executable: event.target.files[0]
            })
        else
            setStateDialog({
                ...stateDialog, file_cleaner: event.target.files[0]
            })
        event.target.value = ''
    }

    const handleCloseDialog = () => {
        setStateDialog({
            name: '', columns: '', description: '', file_executable: null, file_cleaner: null, loading: false
        })
        handleClose()
    }

    const handleUpload = () => {
        setStateDialog({
            ...stateDialog,
            loading: true
        })

        uploadMalware(stateDialog.name, stateDialog.description, stateDialog.file_executable, stateDialog.file_cleaner)
            .then(response => {
                setStateDialog({
                    name: '', columns: '', description: '', file_executable: null, file_cleaner: null, loading: false
                })
                handleSuccess(response.data)
            })
            .catch(error => {
                setStateDialog({
                    ...stateDialog,
                    name: '',
                    showError: true,
                    textError: error.response.data.detail,
                    loading: false
                })
            })
    }

    return (
        <Dialog
            open={open}
            TransitionComponent={Transition}
            keepMounted

            maxWidth="md"
            fullWidth
            aria-describedby="alert-dialog-slide-description"
            PaperProps={{
                style: {
                    backgroundColor: '#676767',
                    color: 'white',
                    fontWeight: 'bold',
                    borderRadius: '25px',
                    maxHeight: '100%'
                }
            }}
        >
            <DialogTitle sx={{fontWeight: 'bold'}}>
                Uploading new malware
                {<IconButton
                    aria-label="close"
                    onClick={handleCloseDialog}
                    sx={{
                        position: 'absolute',
                        right: 8,
                        top: 8,
                        color: 'white'
                    }}
                >
                    <CloseIcon/>
                </IconButton>}
            </DialogTitle>

            <DialogContent>
                <Grid container spacing={2}>
                    <Grid item xs={12}>
                        <a style={{color:'inherit'}} href="malware/cleaner/example" target="_blank">Example of a malware cleaner file format.</a>
                    </Grid>
                    <Grid item xs={12}>
                        <TextFieldStyled
                            name="name"
                            label="Name"
                            value={stateDialog.name}
                            size="small"
                            onChange={onChangeFieldsArea}
                            fullWidth
                            inputProps={{maxLength: 50}}

                            variant="filled"

                        />
                        {
                            stateDialog.showError &&
                            <Grid item xs={12}>
                                <p style={{fontWeight: 'bold'}}>{stateDialog.textError}</p>
                            </Grid>
                        }

                    </Grid>


                    <Grid item xs={12}>
                        <TextFieldStyled
                            name="description"
                            label="Description"
                            size="small"
                            value={stateDialog.description}
                            fullWidth
                            onChange={onChangeFieldsArea}
                            variant="filled"
                            multiline
                            inputProps={{maxLength: 255}}
                            rows={3}
                        />
                    </Grid>


                    <Grid item xs={12}>
                        <Stack direction="row" spacing={2}
                               sx={{justifyContent: 'left', alignItems: 'center'}}>

                            <Button
                                startIcon={<AttachFileIcon/>}
                                size="small" color="success" variant="contained"
                                sx={{borderRadius: '28px', fontWeight: 'bold'}}
                                component="label">
                                Choose malware script
                                <input hidden type="file"
                                       onChange={(event) => onChangeUploadFile(event, 'executable')}/>
                            </Button>

                            <span
                                style={{fontWeight: 'normal'}}>{stateDialog.file_executable === null ? 'No file chosen' : stateDialog.file_executable.name}</span>
                        </Stack>


                    </Grid>
                    <Grid item xs={12}>
                        <Stack direction="row" spacing={2}
                               sx={{justifyContent: 'left', alignItems: 'center'}}>

                            <Button
                                startIcon={<AttachFileIcon/>}
                                size="small" color="warning" variant="contained"
                                sx={{borderRadius: '28px', fontWeight: 'bold'}}
                                component="label">
                                Choose malware cleaner script
                                <input hidden type="file"
                                       onChange={(event) => onChangeUploadFile(event, 'cleaner')}/>
                            </Button>

                            <span
                                style={{fontWeight: 'normal'}}>{stateDialog.file_cleaner === null ? 'No file chosen' : stateDialog.file_cleaner.name}</span>
                        </Stack>


                    </Grid>


                </Grid>

            </DialogContent>
            <DialogActions>

                <LoadingButton
                    disabled={stateDialog.name === "" || stateDialog.description === "" || stateDialog.file_executable === null || stateDialog.file_cleaner === null}
                    size="small" variant="contained"
                    loading={stateDialog.loading}
                    onClick={() => {

                        handleUpload()

                    }}
                    sx={{borderRadius: '28px', fontWeight: 'bold'}}>Upload</LoadingButton>

            </DialogActions>
        </Dialog>


    )
}

export default DialogNewMalware