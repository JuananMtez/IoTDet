import {useEffect, useState} from "react";
import {Alert, Button, CircularProgress, Grid, Snackbar} from "@mui/material";
import * as React from "react";
import DialogNewMalware from "../components/Dialog/DialogNewMalware.jsx";
import {findAllMalware} from "../services/FileRequests.js";
import CardMalware from "../components/Cards/CardMalware.jsx";

const FilesMalware = () => {
    const [state, setState] = useState({
        loading: true,
        malware: [],
        openDialogUploadMalware: false,
        openSuccessUploadMalware: false
    })

    const handleSuccess = (malware) => {

        setState({
            loading: false,
            malware: [...state.malware, malware],
            openSuccessUploadMalware: true,
            openDialogUploadMalware: false
        })
    }

    useEffect(() => {
        findAllMalware()
            .then(response => {
                setState({
                    ...state,
                    loading: false,
                    malware: response.data
                })
            })
    }, [])
    return (
        <Grid container>
            {
                state.loading
                    ?

                    <Grid item xs={12} sx={{mt: '50px'}}>
                        <Grid container alignItems="center" justifyContent="center">
                            <CircularProgress sx={{color: 'white'}}/>
                        </Grid>
                    </Grid>
                    :
                    <Grid container spacing={2}>
                        <Grid container justifyContent="flex-end" sx={{mt: '50px', mb: '30px'}}
                        >
                            <Button disabled={JSON.parse(localStorage.getItem("user")).role === 3}
                                    onClick={() => setState({...state, openDialogUploadMalware: true})} size="small"
                                    variant="contained" sx={{borderRadius: '28px', fontWeight: 'bold'}}
                                    color="success">Upload malware</Button>
                        </Grid>

                        {

                            state.malware.map((el, index) => (
                                <Grid key={index} item xs={3}>
                                    <CardMalware malware={el}/>
                                </Grid>
                            ))
                        }

                    </Grid>


            }

            <DialogNewMalware open={state.openDialogUploadMalware}
                              handleClose={() => setState({...state, openDialogUploadMalware: false})}
                              handleSuccess={handleSuccess}/>
            <Snackbar anchorOrigin={{vertical: "bottom", horizontal: "right"}} open={state.openSuccessUploadMalware}
                      autoHideDuration={3000} onClose={() => setState({...state, openSuccessUploadMalware: false})}>
                <Alert onClose={() => setState({...state, openSuccessUploadMalware: false})} severity="success"
                       sx={{width: '100%'}}>
                    The malware has been uploaded successfully. Wait until an admin validates it!
                </Alert>
            </Snackbar>

        </Grid>
    )
}

export default FilesMalware